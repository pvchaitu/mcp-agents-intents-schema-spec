{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "OpenMCPSpec",
  "version": "v0.8.2",
  "description": "Unified Master Spec that fully subsumes v0.2, v0.3, and v0.8.x. Restores v0.2 fields (parameter defaults/format/dependencies, intent metadata governance, enumeration enabled, error codes array) while keeping v0.8 operational depth, validation logic, and governance.",
  "type": "object",
  "required": ["openmcpspec", "info", "server", "intents", "enumeration"],
  "properties": {
    "openmcpspec": { "type": "string", "default": "v0.8.2" },
    "info": { "$ref": "#/definitions/infoBlock" },
    "server": { "$ref": "#/definitions/serverConfig" },
    "envelope": { "$ref": "#/definitions/protocolEnvelope" },
    "intents": {
      "type": "array",
      "items": { "$ref": "#/definitions/intentDefinition" }
    },
    "enumeration": { "$ref": "#/definitions/enumerationConfig" },
    "governance": { "$ref": "#/definitions/governanceConfig" },
    "lifecycle": { "$ref": "#/definitions/lifecycleConfig" },
    "testing": { "$ref": "#/definitions/testingConfig" },
    "analytics": { "$ref": "#/definitions/analyticsConfig" }
  },

  "definitions": {
    "nlp_hints": {
      "type": "object",
      "description": "Provides LLM guidance for ACI and cost reduction.",
      "properties": {
        "cot_trigger": { "type": "string" },
        "token_optimization_level": { "type": "integer", "enum": [1, 2, 3] },
        "semantic_shorthand": { "type": "string" },
        "example_phrasing": { "type": "array", "items": { "type": "string" } }
      }
    },

    "infoBlock": {
      "type": "object",
      "required": ["title", "version"],
      "properties": {
        "title": { "type": "string" },
        "version": { "type": "string" },
        "description": { "type": "string" },
        "compatibility": { "type": "string" }
      }
    },

    "serverConfig": {
      "type": "object",
      "required": ["name", "hostname", "port", "protocol"],
      "properties": {
        "name": { "type": "string" },
        "hostname": { "type": "string" },
        "port": { "type": "integer" },
        "protocol": { "type": "string", "enum": ["http", "https", "ws", "wss", "sse", "other"] },
        "protocol_hint": { "type": "string" },
        "base_path": { "type": "string" },
        "capabilities": {
          "type": "array",
          "items": { "type": "string", "enum": ["streaming", "sampling", "elicitation", "transactions", "async_callbacks"] }
        },
        "auth": { "$ref": "#/definitions/authConfig" },
        "rate_limits": { "$ref": "#/definitions/rateLimitConfig" },
        "observability": { "$ref": "#/definitions/observabilityConfig" },
        "state_policy": {
          "type": "object",
          "properties": {
            "session_ttl_ms": { "type": "integer" },
            "persistence": { "type": "string", "enum": ["ephemeral", "persistent", "hybrid"] }
          }
        }
      }
    },

    "protocolEnvelope": {
      "type": "object",
      "properties": {
        "request": {
          "type": "object",
          "properties": {
            "id": { "type": "string" },
            "intent": { "type": "string" },
            "parameters": { "type": "object" },
            "deadline_ms": { "type": "integer" },
            "idempotency_key": { "type": "string" },
            "trace_id": { "type": "string" },
            "session_id": { "type": "string" },
            "cancellation_token": { "type": "string" }
          },
          "required": ["id","intent","parameters"]
        },
        "response": {
          "type": "object",
          "properties": {
            "id": { "type": "string" },
            "status": { "type": "string", "enum": ["success","error","partial"] },
            "data": { "type": "object" },
            "error": { "$ref": "#/definitions/errorEnvelope" },
            "progress": { "type": "object", "properties": { "pct": { "type": "number" } } },
            "trace_id": { "type": "string" }
          },
          "required": ["id","status"]
        },
        "stream_chunk": {
          "type": "object",
          "properties": {
            "id": { "type": "string" },
            "chunk_type": { "type": "string", "enum": ["token","row_batch","log","progress"] },
            "payload": { "type": "object" },
            "sequence": { "type": "integer" }
          },
          "required": ["id","chunk_type","payload","sequence"]
        }
      }
    },

    "intentDefinition": {
      "type": "object",
      "required": ["name"],
      "properties": {
        "name": { "type": "string" },
        "description": { "type": "string" },
        "category": { "type": "string" },

        "parameters": {
          "type": "array",
          "items": { "$ref": "#/definitions/parameterDefinition" }
        },

        "nlp_hints": { "$ref": "#/definitions/nlp_hints" },

        "responses": {
          "type": "object",
          "properties": {
            "success": {
              "type": "object",
              "properties": {
                "schema": {
                  "description": "Full JSON Schema (Draft-07+). Supports recursive payloads and external $refs.",
                  "type": ["object", "boolean"],
                  "additionalProperties": true
                },
                "examples": { "type": "array", "items": {} }
              }
            },
            "error": { "$ref": "#/definitions/errorEnvelope" }
          }
        },

        "metadata": { "$ref": "#/definitions/intentMetadata" },

        "validation_logic": {
          "type": "object",
          "properties": {
            "rules": { "type": "array", "items": { "$ref": "#/definitions/logicRule" } }
          }
        },

        "policy_refs": { "type": "array", "items": { "$ref": "#/definitions/policyRef" } },
        "semantic_profile": { "$ref": "#/definitions/semanticProfile" },
        "operational_profile": { "$ref": "#/definitions/operationalProfile" }
      }
    },

    "intentMetadata": {
      "type": "object",
      "description": "Governance and lifecycle metadata restored from v0.2/v0.3.",
      "properties": {
        "roles": { "type": "array", "items": { "type": "string" } },
        "security": { "type": "array", "items": { "type": "string" } },
        "nlp_hints": { "type": "array", "items": { "type": "string" } },
        "version": { "type": "string" },
        "deprecated": { "type": "boolean" },
        "sunset_date": { "type": "string", "format": "date" },
        "migration_hint": { "type": "string" },
        "rbac_scopes": { "type": "array", "items": { "type": "string" } },
        "data_residency": { "type": "string", "enum": ["EU", "US", "APAC", "Global"] },
        "audit_hooks": { "type": "array", "items": { "type": "string" } }
      }
    },

    "parameterDefinition": {
      "type": "object",
      "description": "Unified parameter schema combining v0.8 validation depth with v0.2 fields.",
      "required": ["name", "type"],
      "properties": {
        "name": { "type": "string" },
        "type": { "type": "string" },
        "description": { "type": "string" },
        "required": { "type": "boolean" },

        "default": {},                     

        "pii": { "type": "boolean" },
        "gdpr_sensitive": { "type": "boolean" },

        "enum": { "type": "array" },

        "pattern": { "type": "string" },
        "format": { "type": "string" },

        "minimum": { "type": "number" },
        "maximum": { "type": "number" },

        "dependencies": { "type": "array", "items": { "type": "string" } },

        "items": { "$ref": "#/definitions/parameterDefinition" },
        "properties": { "type": "object", "additionalProperties": { "$ref": "#/definitions/parameterDefinition" } }
      }
    },

    "logicRule": {
      "type": "object",
      "required": ["if_param", "operator"],
      "properties": {
        "if_param": { "type": "string" },
        "operator": { "type": "string", "enum": ["equals", "not_equals", "in", "not_in", "matches", "present", "not_present"] },
        "value": { "type": ["string", "array", "boolean", "number"] },
        "then_require": { "type": "array", "items": { "type": "string" } }
      }
    },

    "errorEnvelope": {
      "type": "object",
      "description": "Comprehensive error taxonomy combining v0.3 enum codes and v0.2 multi-code lists.",
      "required": ["code", "message"],
      "properties": {
        "code": {
          "type": "string",
          "enum": [
            "MCP-ERR-INVALID-REQUEST",
            "MCP-ERR-AUTH-FAILED",
            "MCP-ERR-QUOTA-EXCEEDED",
            "MCP-ERR-CANCELLED",
            "MCP-ERR-TIMEOUT",
            "MCP-ERR-NOT-FOUND",
            "MCP-ERR-UNSUPPORTED"
          ]
        },
        "codes": { "type": "array", "items": { "type": "string" } },

        "message": { "type": "string" },
        "details": { "type": "object" },
        "payload_schema": { "type": ["object", "null"] },

        "retryable": { "type": "boolean" },
        "correlation_id": { "type": "string" },

        "recovery_hints": { "type": "array", "items": { "type": "string" } },
        "standardized": { "type": "boolean", "default": true }
      }
    },

    "enumerationConfig": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },

        "facets": { "type": "array", "items": { "type": "string" } },

        "intent_summary": {
          "type": "object",
          "properties": {
            "name": { "type": "string" },
            "stability": { "type": "string" }
          }
        },

        "conformance_tests": { "type": "array", "items": { "type": "object" } },

        "filters": {
          "type": "object",
          "properties": {
            "categories": { "type": "array", "items": { "type": "string" } },
            "roles": { "type": "array", "items": { "type": "string" } },
            "deprecated": { "type": "boolean" }
          }
        },

        "pagination": {
          "type": "object",
          "properties": {
            "cursor": { "type": "string" },
            "limit": { "type": "integer" },
            "has_more": { "type": "boolean" }
          }
        },

        "versioning": {
          "type": "object",
          "properties": {
            "schema_version": { "type": "string" },
            "compatibility": { "type": "string" },
            "migration_paths": { "type": "array", "items": { "type": "string" } }
          }
        },

        "capability_tags": { "type": "array", "items": { "type": "string" } },
        "intent_groups": { "type": "array", "items": { "type": "string" } }
      }
    },

    "authConfig": {
      "type": "object",
      "properties": {
        "methods": { "type": "array", "items": { "type": "string" } },
        "global_scopes": { "type": "array", "items": { "type": "string" } },
        "jwks_uri": { "type": "string" }
      }
    },

    "rateLimitConfig": {
      "type": "object",
      "properties": {
        "global": {
          "type": "object",
          "properties": {
            "limit": { "type": "integer" },
            "retry_after_hint_ms": { "type": "integer" }
          }
        }
      }
    },

    "observabilityConfig": {
      "type": "object",
      "properties": {
        "slos": { "type": "object", "additionalProperties": { "type": "number" } },
        "trace_header": { "type": "string" }
      }
    },

    "governanceConfig": {
      "type": "object",
      "properties": {
        "pii_redaction": { "type": "boolean" }
      }
    },

    "lifecycleConfig": {
      "type": "object",
      "properties": {
        "changelog": { "type": "array", "items": { "type": "string" } },
        "deprecation_policy": { "type": "object" },
        "compatibility": { "type": "string" }
      }
    },

    "testingConfig": {
      "type": "object",
      "properties": {
        "mock_data": { "type": "object" },
        "validation_cases": { "type": "array", "items": { "type": "string" } },
        "bdd_cases": { "type": "array", "items": { "type": "string" } },
        "conformance_tests": { "type": "array", "items": { "type": "string" } }
      }
    },

    "analyticsConfig": {
      "type": "object",
      "properties": {
        "logging": { "type": "boolean" },
        "metrics": { "type": "array", "items": { "type": "string" } },
        "monitoring_hooks": { "type": "array", "items": { "type": "string" } },
        "trace_id_support": { "type": "boolean" },
        "usage_quota": { "type": "integer" },
        "latency_sla_ms": { "type": "integer" }
      }
    },

    "policyRef": {
      "type": "object",
      "required": ["name", "engine_ref"],
      "properties": {
        "name": { "type": "string" },
        "engine_ref": { "type": "string" },
        "input_schema_hint": { "type": ["object", "string"] }
      }
    },

    "semanticProfile": {
      "type": "object",
      "properties": {
        "idempotent": { "type": "boolean" },
        "side_effects": { "type": "string" }
      }
    },

    "operationalProfile": {
      "type": "object",
      "properties": {
        "avg_latency_ms": { "type": "integer" },
        "cost_units": { "type": "integer" }
      }
    }
  }
}
